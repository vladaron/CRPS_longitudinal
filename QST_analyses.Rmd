---
title: "CRPS mapping: longitudinal analysis - QST data"
date: "`r Sys.Date()`"
output: 
  html_document:
    df_print: paged
    toc: yes
    theme: readable
    highlight: tango
    number_section: no
---

```{r set_up, include = F}

library(ggtext) # vizualization tools
library(kableExtra) # table
library(glue) #string formatting
library(ggplot2) #data vizualization
library(tidyverse) #data handling tools
library(ftExtra) #tables
library(officedown) #table export in .docx
library(officer) #table export in .docx
library(patchwork) #plot assembly
library(readxl) #excel tools
library(writexl) #excel tools
library(flextable) #table
library(grid) #plot assembly
library(ggpubr) #vizualization tools
library(ggsci) #vizualization tools
library(here) #path setting

# flextable formatting
dash_border <- fp_border(color = "gray", style = "dashed")

flextable::set_flextable_defaults(
  font.size = 9, font.family = "Calibri",
  font.color = "#333333",
  table.layout = "autofit",
  border.color = "gray",
  padding.top = 1, padding.bottom = 1,
  padding.left = 1, padding.right = 1,
  footnote_properties = list(
    font.size = 9  # Set the font size to 8
  )
)

# chunk formatting for HTML knitting
knitr::opts_chunk$set(
  tidy    = TRUE,
  warning = FALSE,
  message = FALSE, 
  echo = FALSE,
  comment = FALSE,
  fig.align = "defaut",
  fig.width = 8,
  fig.asp = 0.62,
  out.width = "100%"
  )

```

```{r functions}


# function to vizualize distrubtion of QST parameters for each timepoint and site
hist_fun <- function(d,time, t) {
  


  n_test_mod <- d |>
    filter(side == "affected", redcap_event_code == time) |>
    count(qst_modality)
  
  
  
  
  dd <- full_join(d, n_test_mod) |>
    mutate(qst_modality = toupper(qst_modality)) |> 
    mutate(qst_modality = glue("{qst_modality}\n n = {n}"))
  
  
  
  dd_sum <- dd |>
    group_by(qst_modality, side) |>
    summarise(
      m = mean(values, na.rm = T),
    )
  
  p <- dd |> 
    ggplot(aes(x = values, col = side, fill = side)) +
    geom_histogram(aes(y = after_stat(density)), alpha = 0.5) +
    geom_density(alpha = 0.5) +
    geom_vline(data = dd_sum, aes(xintercept = m, col = side)) +
    facet_wrap(~qst_modality, scales = "free") +
    labs(
      title = paste("Data distribution at ",time, collapse = ""),
      subtitle = {{t}},
      caption = "Vertical lines represents mean values"
    ) 
  p
}


# function used to log tranform
log_qst <- function(x){
  x <- abs(x)
  #x <- x+0.1
  log10(x)
}


# computation of confidence intervals
ci_low <- function(x){
  x <- x[! is.na(x)]
  avg <- mean(x, na.rm = TRUE)
  sd <- sd(x, na.rm = TRUE)
  n <- length(x)
  error <- qnorm(0.95) * sd/sqrt(n)
  avg - error
}

ci_high <- function(x){
  x <- x[! is.na(x)]
  avg <- mean(x)
  sd <- sd(x)
  n <- length(x)
  error <- qnorm(0.95) * sd/sqrt(n)
  avg + error
}


# function that outputs a list of qst data overtime for the affected or non-affected side
# grouping by time point, sex, and extremity
# output 1) data.frame 2) flextable
# input : side < affected vs non-affected

function_tn <- function(s){
  s <- "affected"
  data_set_n <- data_tab_nolog |> 
    filter(side == s) |> 
    select(qst_modality, redcap_event_code, extremity, sex, values) |> 
    group_by(qst_modality, redcap_event_code, extremity, sex)|> 
    summarize(
      n = n()
    ) 
  
  
  
  t_n <- data_set_n |> 
    mutate(qst_modality = toupper(qst_modality)) |> 
    pivot_wider(names_from = c(extremity, sex,  redcap_event_code), values_from = n) |> 
    select(qst_modality, UE_f_T1, UE_f_T3, UE_f_T4, UE_h_T1, UE_h_T3, UE_h_T4, LE_f_T1, LE_f_T3, LE_f_T4, LE_h_T1, LE_h_T3, LE_h_T4)
  
  tn <- flextable(t_n) |> 
    autofit() |> 
    theme_vanilla() |> 
    set_header_labels(
      qst_modality = "QST modalities", 
      "UE_f_T1" = "Baseline", 
      "UE_f_T3" = "6 months", 
      "UE_f_T4" = "12 months", 
      "UE_h_T1" = "Baseline", 
      "UE_h_T3" = "6 months", 
      "UE_h_T4" = "12 months",
      "LE_f_T1" = "Baseline", 
      "LE_f_T3" = "6 months", 
      "LE_f_T4" = "12 months", 
      "LE_h_T1" = "Baseline", 
      "LE_h_T3" = "6 months", 
      "LE_h_T4" = "12 months"
      
    ) |> 
    add_header_row(values = c("QST modalities", "Females", "Males", "Females", "Males"), colwidths = c(1,3,3,3,3)) |> 
    add_header_row(
      values = c("QST modalities", "Upper Extremity", "Lower Extremity"),
      colwidths = c(1,6,6) ) |>
    merge_v(part = "header", j = 1) |> 
    align(part = "header", align = "center") |> 
    align(part = "body", align = "center")
  
  col_v <- c(1,4,7,10,13)
  for (z in col_v){
    tn <- vline(x = tn, j = z, border = dash_border ,part = "all")
  }
  
  res <- list(
    ftn = tn,
    dtn = t_n
  )
  return(res)
  
  
}

# function that outputs a flextable of qst data overtime for the affected or non-affected side
# grouping by time point, sex, and extremity

function_t1 <- function(d, s){
  
  data_set <- d |> 
    filter(side == s) |> 
    select(qst_modality, redcap_event_code, extremity, sex, values) |> 
    group_by(qst_modality, redcap_event_code, extremity, sex)|> 
    summarize(
      m = mean(values, na.rm = TRUE),
      s = sd(values, na.rm = TRUE),
      sem = (sd(values, na.rm = T))/sqrt(length(values)),
      ci_l = ci_low(values),
      ci_h = ci_high(values),
      n = n()
    ) 
  
  n_max <- data_set |> 
    ungroup() |> 
    group_by(redcap_event_code, extremity, sex) |> 
    summarise(n_max = max(n)) |>
    pivot_wider(names_from = c(extremity, sex, redcap_event_code), values_from = n_max) |> 
    select( UE_f_T1, UE_f_T3, UE_f_T4, UE_h_T1, UE_h_T3, UE_h_T4, LE_f_T1, LE_f_T3, LE_f_T4, LE_h_T1, LE_h_T3, LE_h_T4)
  
  
  t <- data_set |> 
    mutate(qst_modality = toupper(qst_modality)
    ) |> 
    mutate(across(where(is.numeric), round, 1)) |> 
    mutate(
      ms = glue("{m} ± {s}")) |> 
    ungroup() |> 
    filter(redcap_event_code != "T2") |> 
    group_by(qst_modality) |> 
    select(! c(m,n, s, sem, ci_l, ci_h)) |> 
    pivot_wider(names_from = c(extremity, sex,  redcap_event_code), values_from = ms) |> 
    select(qst_modality, UE_f_T1, UE_f_T3, UE_f_T4, UE_h_T1, UE_h_T3, UE_h_T4, LE_f_T1, LE_f_T3, LE_f_T4, LE_h_T1, LE_h_T3, LE_h_T4)
  
  t1 <- flextable(t) |> 
    autofit() |> 
    theme_vanilla() |> 
    set_header_labels(
      qst_modality = "QST modalities", 
      "UE_f_T1" = glue("Baseline \n (n = {n_max[,1]})"), 
      "UE_f_T3" = glue("6 months \n (n = {n_max[,2]})"), 
      "UE_f_T4" = glue("12 months \n (n = {n_max[,3]})"),
      "UE_h_T1" = glue("Baseline \n (n = {n_max[,4]})"), 
      "UE_h_T3" = glue("6 months \n (n = {n_max[,5]})"), 
      "UE_h_T4" = glue("12 months \n (n = {n_max[,6]})"), 
      "LE_f_T1" = glue("Baseline \n (n = {n_max[,7]})"), 
      "LE_f_T3" = glue("6 months \n (n = {n_max[,8]})"),  
      "LE_f_T4" = glue("12 months \n (n = {n_max[,9]})"),  
      "LE_h_T1" = glue("Baseline \n (n = {n_max[,10]})"),  
      "LE_h_T3" = glue("6 months \n (n = {n_max[,11]})"), 
      "LE_h_T4" = glue("12 months \n (n = {n_max[,12]})")
      
    ) |> 
    add_header_row(values = c("QST modalities", "Females", "Males", "Females", "Males"), colwidths = c(1,3,3,3,3)) |> 
    add_header_row(
      values = c("QST modalities", "Upper Extremity", "Lower Extremity"),
      colwidths = c(1,6,6) ) |>
    merge_v(part = "header", j = 1) |> 
    align(part = "header", align = "center") |> 
    align(part = "body", align = "center")
  
  col_v <- c(1,4,7,10,13)
  for (z in col_v){
    t1 <- vline(x = t1, j = z, border = dash_border ,part = "all")
  }
  
  t1 <- t1 |> 
    add_footer_lines(
      values = "Mean ± SD. Number of participants are maximal values across all test modalities. Abbreviations: CDT, Cold detection threshold; WDT, Warm detection threshold; TSL, Thermal sensory limen; PHS, Paradoxical heat sensation; CPT, Cold pain threshold; HPT, Heat pain threshold; MDT, Mechanical detection threshold; MPT, Mechanical pain threshold; MPS, Mechanical pain sensitivity; DMA, Dynamic mechanical allodynia; WUR, Wind-up ratio; VDT, Vibration detection threshold; PPT, Pressure pain threshold."
    )
  return(t1)
}


# function that will create a z_score table grouped by timepoint and qst modality
# it includes a single argument: the side (affected vs control)

fun_z_norm <- function(x){

  
  data_full <- full_join(data_tab_log, data_norm) |> 
    select(!cil) 
  data_full_z <- na.omit(data_full)

  
  z_norm <- data_full_z |>  
    mutate(qst_modality = factor(qst_modality,levels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"),labels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"))) |> 
    filter(side == x) |> 
    group_by(sex, redcap_event_code, age_cat, extremity) |> 
    mutate(z = (values - m) / sd) |> 
    mutate(z = if_else(qst_modality %in% c("mps", "cpt", "wur", "vdt"), z, z * (-1)))# multiplying z score by -1 to adequatly rpz gain and loss of function
  
  
  #h <- subset(z_norm, qst_modality == "dma")
  
  z_norm$z[which(z_norm$z == "NaN")] <- 0
  
  
  z_table <- z_norm |> 
    group_by(qst_modality, redcap_event_code) |> 
    summarize(
      m_z_norm = mean(z, na.rm = TRUE),
      s_z_norm = sd(z, na.rm = TRUE),
      sem_z_norm = (sd(z, na.rm = T))/sqrt(length(values)),
      ci_l_z_norm = ci_low(z),
      ci_h_z_norm = ci_high(z)
    )  |> 
    filter(qst_modality != "dma", qst_modality != "phs") 
  
  if(x == "affected"){
    write_csv(z_norm,here("output", "affected_norm.csv" ))
    colnames(z_table) <- c("qst_modality", "redcap_event_code","m_z", "s_z", "sem_z", "ci_l_z", "ci_h_z")
  }
  else{
    write_csv(z_norm,here("output", "affected_norm.csv" ))
    colnames(z_table) <- c("qst_modality", "redcap_event_code","m_z", "s_z", "sem_z", "ci_l_z", "ci_h_z")
  }
  
  return(z_table)
}



# we create a function that will determine the t value as per Magerl et al., 2010

fun.t.new <- function(m_z,s_z, n, print_cat = F){
  t <- (m_z - 0)/ sqrt(s_z^2/n + 1/n)
  ddf <- 2*(n - 1)
  p <- 2*pt(q=abs(t), df=ddf, lower.tail = F)
  p <- round(p, 4)
  decision <- if_else(p < 0.05, "RH0", "NRH0")
  
  ci_up <- (m_z+t^2/2)/(n+t^2)
  ci_low <- (m_z-t^2/2)/(n+t^2)
  
  return(p)
  
  if(print_cat == T){
    cat("Difference between means: \n")
    cat("M1 - M2 = ", m_z, " - 0 = ",m_z,"\n" )
    cat("stat t:", t, "\n")
    cat("p val: ", p,"\n")
    cat("Decision: ", decision)
  }
  
  
}

# we also create a function to assign a value to the specific p values

fun_p_cat <- function(x){
  if(x < 0.05){
    if(x < 0.05 & x > 0.01){cat <- "<0.05"}
    else if(x < 0.01 & x > 0.001){cat <- "<0.01"}
    else{cat <- "<0.001"}
  } else if(x >= 0.05){
    cat <- as.character(x)
  } else{cat <- "NA"}
  return(cat)
}



# function that outputs a flextable of zscored qst data overtime for the affected or non-affected side
# statistical testing is conducted according to Magerl et al 2010  and p values are corrected with bonferroni method.

function_t2 <- function(s){

  data_set_n <- data_tab_log |> 
    filter(side == s) |> 
    select(qst_modality, redcap_event_code, extremity, sex, values) |> 
    group_by(qst_modality, redcap_event_code)|> 
    summarize(
      n = n()
    ) 
  
  z_n <- full_join(fun_z_norm(s), data_set_n) |> 
    filter(qst_modality != "phs", qst_modality !="dma", redcap_event_code != "T2")  
  
  z_n_p <- z_n |>  
    group_by(qst_modality, redcap_event_code) |>
    mutate(
      p = fun.t.new(m_z,s_z, n)
      #p_z_norm_cont = fun.t.new(m_z_norm_cont, s_z_norm_cont,n)
    )  
  
  z_n_p$p_corr <- p.adjust(z_n_p$p, method = "bonferroni")
  
  z_table_full_p <- z_n_p |>
    mutate(across(where(is.numeric), round, 2)) |> 
    mutate(
      p_cat = fun_p_cat(p),
      p_corr_cat = fun_p_cat(p_corr)
    ) |>
    mutate(
      qst_modality = toupper(qst_modality),
      p_cat = glue("{p_cat} / {p_corr_cat}"),
      z = glue("{m_z} ± {s_z}")
    ) 
  
  t2 <- z_table_full_p |> 
    select(qst_modality, redcap_event_code, z, p_cat,n) |> 
    pivot_wider(names_from = redcap_event_code, values_from = c(z, p_cat,n)) |> 
    select(z_T1, n_T1, p_cat_T1, z_T3,n_T3, p_cat_T3, z_T4,n_T4, p_cat_T4) |> 
    flextable() |> 
    theme_vanilla() |> 
    set_header_labels(qst_modality = "QST modalities",
                      z_T1 = "Baseline",
                      n_T1 = "N",
                      p_cat_T1 = "*p* / *p*~corr~",
                      z_T3 = "6 months",
                      n_T3 = "N",
                      p_cat_T3 = "*p* / *p*~corr~",
                      z_T4 = "12 months",
                      n_T4 = "N",
                      p_cat_T4 = "*p* / *p*~corr~"
    ) |> autofit() |> 
    colformat_md(j = c(4,7,10), part = "header") |> 
    align(align = "center", part = "all")
  
  t2 <- vline(t2, j = 1, part = "all", border = dash_border) |> 
    add_footer_lines(
      values = "Mean ± SD. Abbreviations: P corr, Corrected P-values using the Bonferroni correction; CDT, Cold detection threshold; WDT, Warm detection threshold; TSL, Thermal sensory limen; PHS, Paradoxical heat sensation; CPT, Cold pain threshold; HPT, Heat pain threshold; MDT, Mechanical detection threshold; MPT, Mechanical pain threshold; MPS, Mechanical pain sensitivity; DMA, Dynamic mechanical allodynia; WUR, Wind-up ratio; VDT, Vibration detection threshold; PPT, Pressure pain threshold."
    ) 
  res <- list(
    ft2 = t2,
    zt = z_table_full_p
  )
  
  return(res)
  
  
}


# vizualization function
my_theme <- function(base_size = 9, 
                     base_family = 'Arial',
                     base_line_size = base_size / 22,
                     base_rect_size = base_size / 22,
                     md = F) {
  theme(
    axis.line.y = element_line(colour = "black"), 
    axis.line.x = element_line(colour = "black"), 
    panel.background = element_blank(), 
    plot.title = element_text(hjust = 0), 
    plot.subtitle = element_text(hjust = 0),
    axis.title.y = if (md) element_markdown() else element_text(),
    plot.margin = margin(0.5, 0.5, 0.5, 0.5),
    panel.spacing = unit(1, "lines")
  )
}

```




```{r data}
# new names for data set columns
new_names_qst <- c("extremity" = "affected_side","cdt_control" = "cdt" ,  "wdt_control" = "wdt", "tsl_control" = "tsl" , "phs_control" ="psh" , "cpt_control" = "cpt", "hpt_control" = "hpt", "mdt_control" = "mdt","mpt_control"= "mpt", "mps_control" = "mps", "dma_control" = "dma", "wur_control" = "wur","vdt_control" = "vdt" , "ppt_control" = "ppt", "phs_affected" = "psl_affected")

# importing QST data overtime
data <- read_excel(here("data","data_time_qst_20241206.xlsx")) |> 
  rename(all_of(new_names_qst)) %>% # renaming
  mutate(age_cat = case_when( # creating age categories based on ??
    age >= 20 & age < 30 ~ "1",
    age >= 30 & age < 40 ~ "2",
    age >= 40 & age < 50 ~ "3",
    age >= 50 & age < 60 ~ "4",
    age >= 60 ~ "5"
  ),
  age_cat_2 = if_else(age <40, "<40", "≥40")) |> 
  mutate(age_cat = factor(age_cat),
         age_cat_2 = factor(age_cat_2),
      extremity = factor(extremity,levels = c("1","2"), labels = c("UE", "LE")),
      sex = factor(sex, levels = c("1","2"), labels = c("f", "h")),
      redcap_event_code = factor(redcap_event_code, levels = c("1", "2", "3", "4"), labels = c("T1", "T2", "T3", "T4"))
    ) 


# replacing DMA values = 0.1 by 0

data$dma_affected[data$dma_affected == 0.1] <- 0
data$dma_control[data$dma_control == 0.1] <- 0


# normative data
norm <- read_xlsx(here("data", "norms_sdrc_20240307.xlsx"))

# formatting norma dataset
data_norm <- norm |> pivot_longer(cols = starts_with(c("h",  "f")),
                                  names_to = c("sex", "metrics", "age_cat"),
                                  names_sep = "_",
                                  values_to = c("value")) |> 
  pivot_wider(names_from = "metrics",
              values_from = "value") |> 
  mutate(age_cat = factor(age_cat)) |>  
  rename("qst_modality" = "test_mod", "area_qst" = "site") |> 
  mutate(extremity = if_else(area_qst == "foot", "LE", "UE")) |> 
  select(!area_qst) |> 
  mutate(extremity = factor(extremity))







```

```{r logT}
# set of all qst
qst_set <- c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt")
# set of qst to be log transormed
qst_log <- qst_set[!qst_set %in% c("hpt", "cpt", "phs","vdt", "dma")]

data_log <- data %>% mutate(across(starts_with(qst_log), log_qst )) # log transforming data


data_tab_log <- data_log |>  # reformatting the data set with logT data + selecting grouping variables
  select(patient_id,redcap_event_code, age_cat,age_cat_2, extremity, sex, starts_with(qst_set)) |> 
  pivot_longer(
    cols = starts_with(c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt")),
    names_to = c("qst_modality", "side"),
    names_pattern = "(^\\w+)_(\\w+)",
    values_to = "values"
                         ) |> 
  mutate(qst_modality = factor(qst_modality,levels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"),labels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"))) |> na.omit() 

data_tab_nolog <- data  |>  # format long
  select(patient_id,redcap_event_code, age_cat,age_cat_2,extremity, sex, starts_with(qst_set)) |> 
  pivot_longer(
    cols = starts_with(c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt")),
    names_to = c("qst_modality", "side"),
    names_pattern = "(^\\w+)_(\\w+)",
    values_to = "values"
                         ) |> 
  mutate(qst_modality = factor(qst_modality,levels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"),labels = c("cdt", "wdt", "tsl", "phs", "cpt", "hpt", "mdt", "mpt", "mps", "dma", "wur", "vdt", "ppt"))) |> na.omit() 



```


# Raw data {#s1 .tabset .tabset-fade .tabset-pills}

Longitudinal data of CRPS patients cohort. Analysis over 4 time points: T1, first visit; T2, 4.5 months; T3, 6 months; T4, 1 year. Only T1,T3, and T4 are reported and analysed. 


## Distributions raw data {.unnumbered}




```{r dis_raw}


hist_fun(d = data_tab_nolog,time = "T1" ,t = "No log data")
hist_fun(d = data_tab_nolog,time = "T3" ,t = "No log data")
hist_fun(d = data_tab_nolog,time = "T4" ,t = "No log data")
```

## Distributions log T data {.unnumbered}


```{r dis_logT}
hist_fun(d = data_tab_log,time = "T1" ,t = "Log T data")
hist_fun(d = data_tab_log,time = "T3" ,t = "Log T data")
hist_fun(d = data_tab_log,time = "T4" ,t = "Log T data")
```



## Table n participants over time {.unnumbered}


```{r n}


tn <- function_tn(s = "affected")[[1]]
set_caption(tn, caption = "N affected")

tn_cont <- function_tn(s = "control")[[1]]
set_caption(tn, caption = "N contra-lateral")

# output
#save_as_docx(
  #"table n" = tn, 
 # path = here("output/time_analysis", "table_n.docx"))


```

## Table raw data {.unnumbered}

Raw data as $\overline{x} ± {SD}$ grouped by time point, sex and extremity on affected vs non-affected side. 

```{r table_raw}


t_aff_nolog <- function_t1(d = data_tab_nolog, s = "affected")
set_caption(t_aff_nolog, caption = "Raw data affected side")


t_control_nolog <- function_t1(d = data_tab_nolog, s = "control")
set_caption(t_control_nolog, caption = "Raw data contralateral side")

# output
#save_as_docx(
 # "t_aff_nolog" = t_aff_nolog, 
#  path = here("output/time_analysis", "t_aff_nolog.docx"))

#save_as_docx(
 # "t_control_nolog" = t_control_nolog, 
 # path = here("output/time_analysis", "t_control_nolog.docx"))


```

## Table log transformed data {.unnumbered}

Log T data as $\overline{x} ± {SD}$ grouped by time point, sex and extremity on affected vs non-affected side. 

```{r table_nolog}


t_aff_log <- function_t1(d = data_tab_log, s = "affected")
set_caption(t_aff_log, caption = "Log transformed data affected side")


t_control_log <- function_t1(d = data_tab_log, s = "control")
set_caption(t_control_log, caption = "Log transformed data contralateral side")

# output
#save_as_docx(
 # "t_aff_log" = t_aff_log, 
 # path = here("output/time_analysis", "t_aff_log.docx"))

#save_as_docx(
 # "t_control_log" = t_control_log, 
 # path = here("output/time_analysis", "t_control_log.docx"))

```


# Tables z-scores {#s1 .tabset .tabset-fade .tabset-pills}

Z-scores tables ($\overline{x} ± {SD}$) for each QST modality (except PHS and DMA) comparing normative values with the affected and contralateral side of the participants of the cohort.

Grouping: sex and age category

Z scores are created using the following formulas:

$$z_i = \frac{x_{\text{aff},i} - \overline{x}_\text{norm}}{SD_\text{norm}}$$

$$z_i = \frac{x_{\text{cont},i} - \overline{x}_\text{norm}}{SD_\text{norm}}$$

P-values are computed from repeated independent t test using Magerl et al., formula :

$$t = \frac{\overline{x}_\text{exp} - \overline{x}_\text{cont}}{\frac{SD^2_\text{exp}}{n_\text{exp}} + \frac{SD^2_\text{cont}}{n_\text{cont}}}$$

where $\overline{x}_\text{cont} = 0$; $SD_\text{cont} = 1$; $n_\text{exp} = n_\text{cont}$.


```{r}

t2_aff <- function_t2("affected")[[1]]
set_caption(t2_aff, caption = "Z-scores: affected vs norm")

t2_cont <- function_t2("control")[[1]]
set_caption(t2_cont, caption = "Z-scores: contralateral vs norm")

# output
#save_as_docx(
 # "table z aff" = t2_aff, 
 # path = here("output/time_analysis", "t2_aff.docx"))


#save_as_docx(
 # "table z cont" = t2_cont, 
 # path = here("output/time_analysis", "t2_cont.docx"))

```

# Figures z_scores

Z-scores across qst modalities. Error bars are CI 95%. Stars indicate significance after bonferroni correction of p values.

```{r figz, fig.dim=c(9,7)}

# z scores data
d_aff <- function_t2("affected")[[2]] |> 
  select(qst_modality, redcap_event_code, m_z, ci_l_z, ci_h_z, p_corr)
d_aff$group <- rep("Affected vs norm", nrow(d_aff))

d_cont <- function_t2("control")[[2]] |> 
  select(qst_modality, redcap_event_code, m_z, ci_l_z, ci_h_z, p_corr)
d_cont$group <- rep("Contralateral vs norm", nrow(d_cont))

d_aff_cont <- rbind(d_aff, d_cont)

# figure data & formatting
fig.data <- d_aff_cont |> 
  mutate(
    redcap_event_code = factor(redcap_event_code, levels = c("T1", "T3", "T4"), labels = c("Baseline", "6 months", "12 months")),
    qst_modality = factor(qst_modality, levels = c("CDT", "WDT", "TSL", "CPT","HPT", "PPT", "MPT", "MPS", "WUR", "MDT", "VDT"))) |> 
  rename(z = m_z) |> 
  mutate(
    high = ci_h_z,
    low = ci_l_z,
    p_point = if_else(p_corr<0.05, high + 0.3, 100)) 

# position argument
  pos <- position_dodge(width=0.6)
  
  d.rect <- data.frame(x1 = 0, x2 = Inf, y1 = -1.96, y2 = 1.96)
  
  # figure annotation
    txt_gain <- text_grob(label = "Gain of function", size = 8,rot = 90, color = "grey")
  txt_loss <- text_grob(label = "Loss of function", size = 8,rot = 90, color = "grey")
  
  # figure code
  figz_bis <- fig.data |> 
    ggplot() +
    geom_errorbar(aes(x = qst_modality, y = z, col = group, ymin = low, ymax = high), width = 0.2, position = pos) +
  geom_point(aes(x = qst_modality, y = z, col = group), size = 3, position = pos) +
    geom_point( aes(x = qst_modality, y = p_point, col= group), shape = 8, position = pos, size = 0.7) +
  scale_y_continuous(limits = c(-4,4), breaks = seq(-3,3,1)) +
  geom_hline(yintercept = 0, alpha = 0.7) +
  geom_hline(yintercept = c(-1.96,1.96), alpha = 0.7, linetype = "dashed") +
       geom_rect(data = d.rect, aes(xmin = x1, xmax = x2, ymin = y1, ymax = y2), alpha = 0.2, fill = "lightgrey") +
    scale_color_lancet() +
  labs(
    title = "",
    y = "Z-score",
    x = "QST parameters",
    col = "",
    shape = "",
    linetype = ""
  ) +
    annotation_custom(txt_loss, ymin  = -1, ymax = -3, xmin = -1, xmax = 0.2) +
   annotation_custom(txt_gain, ymin  = 1, ymax = 3, xmin = -1, xmax = 0.2) +
    facet_grid(rows = vars(redcap_event_code)) +
    my_theme() +
  coord_cartesian(clip = "off") + 
  theme(axis.title.y = element_text(margin = margin(t = 0, r = 20, b = 0, l = 0))) +
    theme(legend.position = "bottom") 
figz_bis
# export
#ggsave("figz_bis.png", plot = figz_bis, path = here("output/time_analysis"), width = 11, height = 9)
 
```




